{% extends "coal/base-fluid.html" %}

{% if error %}
    <script>showMessage('error', "{{ error }}");</script>
{% endif %}

{% block title %}New Shibboleth User{% endblock %}

{% block content %}
    <div class="row-fluid">
        <div class="col-sm-12">
            <div class="page-header">
                <h2>Adding Shibboleth User to Cloud</h2>
            </div>
        </div>
        <div class="col-sm-12">
            <div class="col-sm-12">
                <h6>Your User Info:</h6>

                <div class="col-sm-6">
                    <label class="label">Username:</label>

                    <p>{{ shib_user }}</p>
                </div>
                <div class="col-sm-6">
                    <label class="label">E-Mail:</label>

                    <p>{{ shib_email }}</p>
                </div>
            </div>
            <div class="col-sm-12">
                <h6>
                    {% if is_default_shib == 1 %}
                        You are being added to Project {{ project_info.project_name }}:
                    {% else %}
                        New Project {{ project_info.project_name }} will be built for you:
                    {% endif %}
                </h6>
                <table class="table table-bordered table-striped table-responsive table-hover">
                    <thead>
                    <tr>
                        <th>Project Details</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Name</td>
                        <td>{{ project_info.project_name }}</td>
                    </tr>
                    <tr>
                        <td>Default Network</td>
                        <td>{{ project_info.def_network_name }}</td>
                    </tr>
                    <tr>
                        <td>Default Security Group</td>
                        <td>{{ project_info.def_security_group_name }}</td>
                    </tr>
                    <tr>
                        <td>Default Security Key</td>
                        <td>{{ project_info.def_security_key_name }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <button class="btn btn-lg btn-primary confirm-shib-user">Confirm</button>
    </div>
{% endblock %}

<script>
    var isDefaultShib = parseInt({{ is_default_shib }}) == 1;
    $(function () {
        $(".confirm-shib-user").click(function () {
            $(".confirm-shib-user").prop("disabled", "disabled");
            if (isDefaultShib) {
                showMessage("Adding user to {{ project_info.project_name }}.");
                $.getJSON("/third_party_authentication/shib/add_user/{{ shib_user }}/{{ shib_email }}/{{ project_info.project_id }}/")
                        .done(function (data) {
                            if (data.status == "success") {
                                showMessage('success', "Successfully added {{ shib_user }} to {{ project_info.project_name }}, redirecting to Project View ...");
                                location.replace("/projects/{{ project_info.project_id }}/view");
                            }
                            if (data.status == "error") {
                                showMessage('error', data.message);
                                $(".confirm-shib-user").removeProp("disabled");
                            }
                        })
                        .fail(function () {
                            showMessage('error', "Server Fault");
                            $(".confirm-shib-user").removeProp("disabled");
                        })
            } else {
                showMessage("Building Project {{ project_info.project_name }}.");
                $.getJSON("/third_party_authentication/shib/add_user/{{ shib_user }}/{{ shib_email }}/")
                        .done(function (data) {
                            if (data.status == "success") {
                                showMessage('success', "Successfully built {{ project_info.project_name }}, redirecting to Project View ...");
                                location.replace("/projects/" + data.user.project_id + "/view");
                            }
                            if (data.status == "error") {
                                showMessage('error', data.message);
                                $(".confirm-shib-user").removeProp("disabled");
                            }
                        })
                        .fail(function () {
                            showMessage('error', "Server Fault");
                            $(".confirm-shib-user").removeProp("disabled");
                        })

            }
        });
    });
</script>